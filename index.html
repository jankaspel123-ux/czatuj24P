<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Czatuj24</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Share+Tech+Mono&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --lime:#39ff14;
  --bg-dark:#000;
  --bg-light:#fff;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Roboto Mono',monospace;
  background:var(--bg-dark);
  color:var(--lime);
  height:100vh;
  display:flex;
  flex-direction:column;
  background-size:cover;
  background-position:center;
  transition:background .2s,color .2s;
  overflow:hidden;
}
body.light{
  background:var(--bg-light);
  color:#000;
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  border-bottom:1px solid rgba(57,255,20,.15);
  background:rgba(0,0,0,.6);
}
body.light header{
  background:rgba(255,255,255,.9);
}
.logo{
  font-family:'Press Start 2P',monospace;
  font-weight:700;
  font-size:1.6rem;
  color:var(--lime);
  text-shadow:0 0 20px rgba(57,255,20,.8);
  animation:glow 1.5s infinite alternate;
}
@keyframes glow{
  0%{text-shadow:0 0 12px rgba(57,255,20,.4);}
  50%{text-shadow:0 0 28px rgba(57,255,20,.85);}
  100%{text-shadow:0 0 12px rgba(57,255,20,.4);}
}
.header-center{
  display:flex;
  align-items:center;
  gap:12px;
}
.online-indicator{
  font-family:'Roboto Mono',monospace;
  font-size:0.85rem;
  font-weight:700;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid rgba(57,255,20,.18);
  background:rgba(0,0,0,.25);
  text-shadow:0 0 8px rgba(57,255,20,.6);
}
.small-status{
  font-family:'Roboto Mono',monospace;
  font-size:0.75rem;
  opacity:.95;
  text-shadow:0 0 6px rgba(57,255,20,.5);
}
.header-buttons{
  display:flex;
  align-items:center;
  gap:6px;
}
.main{flex:1;display:flex;gap:12px;padding:12px;overflow:hidden;}
.chat{flex:1;display:flex;flex-direction:column;border-radius:8px;overflow:hidden;}
.messages{flex:1;padding:12px;display:flex;flex-direction:column;gap:8px;overflow:auto;background:rgba(0,0,0,.45);border-radius:8px;}
body.light .messages{background:rgba(255,255,255,.75);}
.msg{display:flex;align-items:flex-start;gap:8px;max-width:75%;animation:msgIn .18s ease;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(57,255,20,.18);}
.bubble{padding:8px 12px;border-radius:12px;background:#111;border:1px solid rgba(57,255,20,.06);color:var(--lime);}
.self .bubble{background:var(--lime);color:#000;}
.self{align-self:flex-end;flex-direction:row-reverse;}
.profile-panel{position:fixed;right:0;top:0;width:320px;height:100%;transform:translateX(100%);background:rgba(0,0,0,.95);padding:12px;display:flex;flex-direction:column;gap:8px;border-left:2px solid rgba(57,255,20,.12);transition:transform .22s;z-index:100;}
.profile-panel.open{transform:translateX(0);}
.profile-top{display:flex;justify-content:space-between;align-items:center;}
.profile-top h3{margin:0;font-family:'Share Tech Mono',monospace;color:var(--lime);}
.profile-actions button{background:transparent;border:1px dashed rgba(57,255,20,.14);color:var(--lime);padding:6px;border-radius:8px;cursor:pointer;transition:all .2s;}
.profile-actions button:hover{transform:translateY(-2px) scale(1.05);}
.profile-panel label{font-weight:600;font-size:.9rem;}
.profile-panel input[type=text],.profile-panel input[type=number],.profile-panel select,.profile-panel textarea{
  padding:8px;border-radius:8px;border:1px solid rgba(57,255,20,.12);background:#0f0f0f;color:var(--lime);width:100%;transition:all .2s;}
body.light .profile-panel input,body.light .profile-panel select,body.light .profile-panel textarea{background:#fff;color:#000;}
.profile-avatar{width:90px;height:90px;border-radius:50%;object-fit:cover;box-shadow:0 0 16px rgba(57,255,20,.25);transition:all .3s;}
.profile-avatar:hover{transform:scale(1.05);}
.panel-row{display:flex;gap:8px;}
.panel-row>div{flex:1;}
.controls{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:12px;
  border-top:1px solid rgba(57,255,20,.06);
  background:rgba(0,0,0,.6);
}
body.light .controls{background:rgba(255,255,255,.9);}
.text-input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(57,255,20,.12);background:#0f0f0f;color:var(--lime);transition:all .2s;}
body.light .text-input{background:#fff;color:#000;}
.btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-family:'Press Start 2P',monospace;position:relative;animation:buttonGlow 2s infinite alternate;transition:all .2s;}
.btn:hover{transform:translateY(-2px) scale(1.05);}
@keyframes buttonGlow{
  0%{box-shadow:0 0 8px rgba(57,255,20,.35);}
  50%{box-shadow:0 0 22px rgba(57,255,20,.85);}
  100%{box-shadow:0 0 8px rgba(57,255,20,.35);}
}
.btn-start{background:var(--lime);color:#000;animation:btnPulse 1.5s infinite alternate;}
.btn-stop{background:transparent;color:var(--lime);border:1px solid rgba(57,255,20,.18);animation:btnPulse 1.5s infinite alternate;}
@keyframes btnPulse{
  0%{transform:scale(1) translateY(0);}
  50%{transform:scale(1.02) translateY(-1px);}
  100%{transform:scale(1) translateY(0);}
}
#toggleTheme,#muteToggle,#openProfile{
  font-family:'Share Tech Mono',monospace;
  font-size:1.1rem;
  background:transparent;
  border:none;
  color:var(--lime);
  cursor:pointer;
  transition:all .2s;
}
#toggleTheme:hover,#muteToggle:hover,#openProfile:hover{transform:scale(1.1);}
img.chat-img{max-width:120px;max-height:120px;border-radius:8px;cursor:pointer;transition:all .2s;}
img.chat-img:hover{transform:scale(1.15);}
@media(max-width:760px){
  .profile-panel{width:92vw}
  .logo{font-size:1.25rem}
  .controls {flex-direction:column; gap:4px;}
  .text-input, .btn {width:100%;}
}

/* --- overlay / modal zgody i loading --- */
#consentOverlay{
  position:fixed;
  inset:0;
  background:linear-gradient(0deg, rgba(0,0,0,.85), rgba(0,0,0,.6));
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:20px;
  color:var(--lime);
}
#consentBox{
  max-width:980px;
  width:100%;
  max-height:86vh;
  overflow:auto;
  background:rgba(10,10,10,.95);
  border-radius:10px;
  padding:18px;
  border:1px solid rgba(57,255,20,.08);
}
#consentBox h2{margin-top:0;font-family:'Share Tech Mono',monospace;}
#consentText{font-size:0.9rem;line-height:1.45;color:inherit;}
#consentActions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px;}
#consentText p{margin:8px 0;}
.consent-btn{padding:10px 16px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-family:'Press Start 2P',monospace;}
.accept{background:var(--lime);color:#000;}
.decline{background:transparent;color:var(--lime);border:1px solid rgba(57,255,20,.12);}

/* small note area */
#consentNotice{font-size:0.8rem;color:rgba(57,255,20,.9);margin-bottom:8px;}
</style>
</head>
<body>

<header>
  <div class="logo">Czatuj24</div>
  <div class="header-center">
    <div class="online-indicator"><span id="onlineCount">Online: 0</span></div>
    <div class="small-status" id="statusInfo">TwÃ³j status: offline â€¢ Partner: brak</div>
  </div>
  <div class="header-buttons">
    <button id="toggleTheme">ğŸŒ™</button>
    <button id="muteToggle">ğŸ”Š</button>
    <button id="openProfile">ğŸ§‘â€ğŸ’» Profil</button>
  </div>
</header>

<div class="main">
  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="controls">
      <input id="msgInput" class="text-input" placeholder="Napisz wiadomoÅ›Ä‡..." />
      <!-- hidden file input powiÄ…zany z przyciskiem WyÅ›lij -->
      <input type="file" id="photoInput" accept="image/*" style="display:none" />
      <button id="sendBtn" class="btn btn-start" disabled>WyÅ›lij</button>
      <button id="startBtn" class="btn btn-start">Start</button>
      <button id="stopBtn" class="btn btn-stop" disabled>Stop</button>
    </div>
  </div>
</div>

<aside class="profile-panel" id="profilePanel">
  <div class="profile-top">
    <h3>TwÃ³j profil</h3>
    <div class="profile-actions">
      <button id="hideProfile" title="Schowaj">â‹®</button>
      <button id="closeProfile" title="Zamknij">âœ–</button>
    </div>
  </div>

  <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
    <img id="avatarPreview" class="profile-avatar" src="https://i.pravatar.cc/90" alt="avatar" />
    <input id="avatarInput" type="file" accept="image/*" />
    <input id="bgInput" type="file" accept="image/*" />
  </div>

  <label>Nick:</label>
  <input type="text" id="profileNick" maxlength="20" />

  <div class="panel-row">
    <div>
      <label>Ja jestem:</label>
      <select id="profileSex">
        <option value="kobieta">Kobieta</option>
        <option value="mezczyzna">MÄ™Å¼czyzna</option>
        <option value="bi">Bi</option>
      </select>
    </div>
    <div>
      <label>Kogo szukam:</label>
      <select id="profileTarget">
        <option value="kobieta">Kobieta</option>
        <option value="mezczyzna">MÄ™Å¼czyzna</option>
        <option value="bi">Bi</option>
      </select>
    </div>
  </div>

  <label>Cel czatu:</label>
  <select id="profilePurpose">
    <option value="randka">Randka</option>
    <option value="spotkanie">Spotkanie</option>
    <option value="seks">Seks</option>
    <option value="rozmowa">Rozmowa</option>
  </select>

  <label>Wiek: <span id="ageValue">25</span></label>
  <input type="range" id="profileAge" min="18" max="100" value="25" />

  <label>Biogram (max 200 znakÃ³w):</label>
  <textarea id="profileBio" maxlength="200" placeholder="KrÃ³tki opis..."></textarea>
  <div style="text-align:right;font-size:11px;"><span id="bioCount">0</span>/200</div>

  <label>Status:</label>
  <select id="profileStatus">
    <option value="dostepny">DostÄ™pny</option>
    <option value="zaraz">Zaraz wracam</option>
  </select>

  <button id="resetProfile" class="btn btn-stop">PrzywrÃ³Ä‡ ustawienia</button>
</aside>

<!-- Overlay zgody / loading -->
<div id="consentOverlay" aria-hidden="false" role="dialog">
  <div id="consentBox" role="document">
    <div id="consentNotice">Zanim wejdziesz â€” przeczytaj i zaakceptuj naszÄ… PolitykÄ™ PrywatnoÅ›ci oraz Regulamin (RODO / 2025).</div>
    <h2>Polityka prywatnoÅ›ci i regulamin â€” Czatuj24</h2>
    <div id="consentText">
      <p><strong>Administrator danych:</strong> [Czatuj24].</p>

      <h3>1. Zakres i cel przetwarzania danych</h3>
      <p>Serwis Czatuj24 umoÅ¼liwia anonimowÄ… komunikacjÄ™ pomiÄ™dzy uÅ¼ytkownikami w trybie czatu losowego. W ramach dziaÅ‚ania serwisu mogÄ… byÄ‡ przetwarzane dane osobowe i informacje udostÄ™pniane dobrowolnie przez uÅ¼ytkownikÃ³w (np. nickname, avatar, pliki multimedialne wysyÅ‚ane do drugiego uÅ¼ytkownika). Administrator nie przechowuje treÅ›ci konwersacji w bazie danych w standardowej konfiguracji â€” serwer dziaÅ‚a jako poÅ›rednik i pliki wysÅ‚ane do drugiego uÅ¼ytkownika mogÄ… byÄ‡ tymczasowo przechowywane w katalogu <code>/uploads</code> celem udostÄ™pnienia ich partnerowi czatu.</p>

      <h3>2. Podstawy prawne przetwarzania</h3>
      <p>Przetwarzamy dane na podstawie:</p>
      <ul>
        <li>art. 6 ust. 1 lit. a RODO â€” jeÅ¼eli uÅ¼ytkownik wyrazi zgodÄ™ na przetwarzanie (np. akceptujÄ…c niniejszÄ… politykÄ™),</li>
        <li>art. 6 ust. 1 lit. f RODO â€” prawnie uzasadniony interes administratora (np. utrzymanie bezpieczeÅ„stwa, zapobieganie naduÅ¼yciom, analiza statystyczna anonymizowana),</li>
        <li>inne podstawy prawne, gdy jest to wymagane przepisami prawa.</li>
      </ul>

      <h3>3. Zakres gromadzonych danych</h3>
      <p>MoÅ¼emy przetwarzaÄ‡ nastÄ™pujÄ…ce dane:</p>
      <ul>
        <li>nickname (wpisany przez uÅ¼ytkownika),</li>
        <li>avatar przesÅ‚any przez uÅ¼ytkownika (plik graficzny),</li>
        <li>pliki przesÅ‚ane w trakcie rozmowy (obrazy),</li>
        <li>dane techniczne (adres IP, user-agent, timestamp) w celach bezpieczeÅ„stwa i diagnostyki â€” przechowywane okresowo w logach serwera,</li>
        <li>informacje o zgodach i preferencjach przechowywane lokalnie (np. w localStorage) lub na serwerze w przyszÅ‚ej wersji.</li>
      </ul>

      <h3>4. Cele przetwarzania</h3>
      <p>Dane przetwarzane sÄ… w celu:</p>
      <ul>
        <li>umoÅ¼liwienia komunikacji miÄ™dzy uÅ¼ytkownikami (przekazywanie wiadomoÅ›ci i plikÃ³w),</li>
        <li>zapewnienia bezpieczeÅ„stwa i wykrywania naduÅ¼yÄ‡,</li>
        <li>realizacji statystyk i analiz (dane agregowane/anonymizowane) celem poprawy dziaÅ‚ania serwisu i kampanii reklamowych,</li>
        <li>wypeÅ‚nienia obowiÄ…zkÃ³w prawnych, jeÅ›li zachodzi taka koniecznoÅ›Ä‡.</li>
      </ul>

      <h3>5. Okres przechowywania</h3>
      <p>Pliki przesÅ‚ane przez uÅ¼ytkownikÃ³w (np. obrazy) sÄ… przechowywane w katalogu <code>/uploads</code> przez okres zaleÅ¼ny od konfiguracji serwera. W standardowej konfiguracji administrator zastrzega sobie prawo do okresowego usuwania plikÃ³w (np. 30 dni). Logi techniczne przechowywane sÄ… przez okres niezbÄ™dny do zapewnienia bezpieczeÅ„stwa oraz realizacji obowiÄ…zkÃ³w prawnych.</p>

      <h3>6. Odbiorcy danych</h3>
      <p>Dane nie sÄ… sprzedawane ani celowo udostÄ™pniane podmiotom trzecim z wyjÄ…tkiem:</p>
      <ul>
        <li>dostawcÃ³w usÅ‚ug hostingowych i infrastruktury (np. Render, Cloud Provider),</li>
        <li>organy paÅ„stwowe, jeÅ¼eli wymagajÄ… tego przepisy prawa (np. na Å¼Ä…danie uprawnionych organÃ³w). </li>
      </ul>

      <h3>7. Prawa osÃ³b, ktÃ³rych dane dotyczÄ…</h3>
      <p>Masz prawo do:</p>
      <ul>
        <li>dostÄ™pu do swoich danych,</li>
        <li;sprostowania danych,</li>
        <li;usuniÄ™cia danych (â€prawo do bycia zapomnianymâ€), w zakresie w jakim administrator faktycznie przechowuje dane osobowe,</li>
        <li;ograniczenia przetwarzania,</li>
        <li;przenoszenia danych,</li>
        <li;wniesienia sprzeciwu wobec przetwarzania danych,</li>
        <li;wniesienia skargi do organu nadzorczego (PUODO). </li>
      </ul>

      <h3>8. Cookies i lokalne przechowywanie</h3>
      <p>Serwis moÅ¼e korzystaÄ‡ z ciasteczek (cookies) lub mechanizmÃ³w lokalnego przechowywania (localStorage) w celu zapamiÄ™tania ustawieÅ„ i zgÃ³d. Cookies techniczne sÄ… konieczne dla funkcjonalnoÅ›ci i nie wymagajÄ… oddzielnej zgody. W przypadku cookies sÅ‚uÅ¼Ä…cych analizie i marketingowi uÅ¼ytkownik bÄ™dzie poproszony o wyraÅ¼enie zgody, jeÅ›li takie mechanizmy zostanÄ… wprowadzone.</p>

      <h3>9. BezpieczeÅ„stwo</h3>
      <p>Administrator stosuje Å›rodki techniczne i organizacyjne adekwatne do ryzyka (np. ograniczenie dostÄ™pu do katalogu uploads, zabezpieczenia serwera). Nie moÅ¼na jednak caÅ‚kowicie wykluczyÄ‡ ryzyka naruszeÅ„; uÅ¼ytkownik przesyÅ‚ajÄ…c dane zgadza siÄ™ na ryzyko zwiÄ…zane z przesyÅ‚aniem treÅ›ci przez Internet.</p>

      <h3>10. Reklama i analityka</h3>
      <p>Administrator zastrzega sobie prawo do prowadzenia dziaÅ‚aÅ„ marketingowych i analitycznych (np. kampanii reklamowych). Dane wykorzystane do takich analiz bÄ™dÄ… agregowane i anonimizowane, chyba Å¼e uÅ¼ytkownik wyrazi zgodÄ™ na inny sposÃ³b przetwarzania danych.</p>

      <h3>11. Zmiany polityki</h3>
      <p>Administrator moÅ¼e aktualizowaÄ‡ niniejszÄ… politykÄ™. O waÅ¼nych zmianach uÅ¼ytkownik zostanie poinformowany w sposÃ³b adekwatny (np. przez komunikat w serwisie).</p>

      <p><strong>Kontakt:</strong> Prosimy o kontakt z administratorem pod adresem e-mail: <em>[kontaktczatuj24@gmail.com]</em> w sprawach dotyczÄ…cych prywatnoÅ›ci i realizacji praw podmiotÃ³w danych.</p>

      <p><em>Poprzez klikniÄ™cie â€AkceptujÄ™â€ oÅ›wiadczasz, Å¼e zapoznaÅ‚eÅ› siÄ™ z powyÅ¼szÄ… PolitykÄ… PrywatnoÅ›ci i Regulaminem oraz wyraÅ¼asz zgodÄ™ (w zakresie wskazanym powyÅ¼ej) na przetwarzanie danych osobowych w ramach serwisu Czatuj24.</em></p>
    </div>

    <div id="consentActions">
      <button id="declineBtn" class="consent-btn decline">Odrzucam</button>
      <button id="acceptBtn" class="consent-btn accept">Akceptuje i kontynuuje</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io(window.location.origin, {
  transports: ['websocket'],
  reconnection: true
});

const profilePanel = document.getElementById('profilePanel');
document.getElementById('openProfile').addEventListener('click', ()=>{profilePanel.classList.add('open');});
document.getElementById('closeProfile').addEventListener('click', ()=>{profilePanel.classList.remove('open');});
document.getElementById('hideProfile').addEventListener('click', ()=>{profilePanel.classList.toggle('open');});

const avatarInput = document.getElementById('avatarInput');
const avatarPreview = document.getElementById('avatarPreview');
const bgInput = document.getElementById('bgInput');

avatarInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    avatarPreview.src = URL.createObjectURL(file);
    // opcjonalnie moÅ¼na wysyÅ‚aÄ‡ avatar na serwer tu, ale aktualnie tylko lokalna podmiana
    // sendPhoto(file); // nie wymuszamy wysyÅ‚ania avatara jako wiadomoÅ›ci
  }
});
bgInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    document.body.style.backgroundImage = `url(${URL.createObjectURL(file)})`;
    document.body.style.backgroundRepeat = "no-repeat";
    document.body.style.backgroundSize = "cover";
  }
});

const ageSlider = document.getElementById('profileAge');
const ageValue = document.getElementById('ageValue');
ageSlider.addEventListener('input', ()=>{ ageValue.textContent = ageSlider.value; });

const bioTextarea = document.getElementById('profileBio');
const bioCount = document.getElementById('bioCount');
bioTextarea.addEventListener('input', ()=>{ bioCount.textContent = bioTextarea.value.length; });

document.getElementById('resetProfile').addEventListener('click', ()=>{
  avatarPreview.src = "https://i.pravatar.cc/90";
  document.body.style.backgroundImage = "";
  document.getElementById('profileNick').value = '';
  document.getElementById('profileSex').value = 'kobieta';
  document.getElementById('profileTarget').value = 'kobieta';
  document.getElementById('profilePurpose').value = 'randka';
  document.getElementById('profileAge').value = 25;
  ageValue.textContent = 25;
  document.getElementById('profileBio').value = '';
  bioCount.textContent = 0;
  document.getElementById('profileStatus').value = 'dostepny';
});

const msgInput = document.getElementById('msgInput');
const photoInput = document.getElementById('photoInput');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const muteToggle = document.getElementById('muteToggle');
const toggleTheme = document.getElementById('toggleTheme');

let chatRunning = false;
let muted = false;
const messages = document.getElementById('messages');

const soundSend = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
const soundReceive = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
const soundStart = new Audio('https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg');
const soundStop = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

muteToggle.addEventListener('click', ()=>{ muted=!muted; muteToggle.textContent = muted ? "ğŸ”‡" : "ğŸ”Š"; });

toggleTheme.addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  toggleTheme.textContent = document.body.classList.contains('light') ? "ğŸŒ" : "ğŸŒ™";
});

function playSound(sound){ if(!muted) sound.play(); }

// --- consent overlay logic ---
const consentOverlay = document.getElementById('consentOverlay');
const acceptBtn = document.getElementById('acceptBtn');
const declineBtn = document.getElementById('declineBtn');

function enableControlsAfterConsent(){
  // odblokuj podstawowe kontrolki
  startBtn.disabled = false;
  // sendBtn i msgInput bÄ™dÄ… aktywowane przy starcie czatu (jak wczeÅ›niej)
  consentOverlay.style.display = 'none';
  consentOverlay.setAttribute('aria-hidden', 'true');
}

function disableControlsBeforeConsent(){
  startBtn.disabled = true;
  sendBtn.disabled = true;
  msgInput.disabled = true;
  stopBtn.disabled = true;
  consentOverlay.style.display = 'flex';
  consentOverlay.setAttribute('aria-hidden', 'false');
}

// jeÅ›li wczeÅ›niej zaakceptowano
if(localStorage.getItem('czatuj24_consent') === 'true'){
  enableControlsAfterConsent();
} else {
  disableControlsBeforeConsent();
}

acceptBtn.addEventListener('click', ()=>{
  localStorage.setItem('czatuj24_consent','true');
  enableControlsAfterConsent();
});

declineBtn.addEventListener('click', ()=>{
  // jeÅ›li odrzuca, wyloguj/przekieruj â€” uÅ¼ytkownik nie ma dostÄ™pu
  try {
    // prÃ³bujemy zamknÄ…Ä‡ okno lub przekierowaÄ‡
    window.location.href = 'https://www.google.com';
  } catch(e){
    window.close();
  }
});

// --- koniec consent ---

startBtn.addEventListener('click', ()=>{
  if(!localStorage.getItem('czatuj24_consent')){ alert('Musisz zaakceptowaÄ‡ politykÄ™ prywatnoÅ›ci aby korzystaÄ‡ z serwisu.'); return; }
  chatRunning = true;
  msgInput.disabled = false;
  sendBtn.disabled = false;
  stopBtn.disabled = false;
  addSystemMsg("ÅÄ…czenie z partnerem...");
  socket.emit('startChat');
  playSound(soundStart);
});
stopBtn.addEventListener('click', ()=>{
  if(!chatRunning) return;
  if(confirm("Czy zakoÅ„czyÄ‡ czat?")){
    chatRunning = false;
    msgInput.disabled = true;
    sendBtn.disabled = true;
    stopBtn.disabled = true;
    addSystemMsg("Czat zakoÅ„czony.");
    socket.emit('stopChat');
    playSound(soundStop);
  }
});

// ObsÅ‚uga wysyÅ‚ania: jeÅ›li w msgInput jest tekst -> wysyÅ‚a tekst; jeÅ›li puste -> otwiera picker zdjÄ™Ä‡
sendBtn.addEventListener('click', ()=>{
  if(msgInput.value.trim() !== ''){
    sendMsg();
  } else {
    // jeÅ›li uÅ¼ytkownik chce wrzuciÄ‡ plik, otwÃ³rz dialog plikÃ³w
    photoInput.click();
  }
});

// enter -> wysyÅ‚ka tekstu (jak wczeÅ›niej)
msgInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMsg(); });

function sendMsg(){
  if(!chatRunning) return;
  const text = msgInput.value.trim();
  if(!text) return;
  addMsg('self', text, avatarPreview.src);
  socket.emit('sendMessage', text);
  playSound(soundSend);
  msgInput.value = '';
}

// photoInput change => wysyÅ‚amy plik (bez ograniczeÅ„ po stronie frontu)
photoInput.addEventListener('change', e=>{
  if(e.target.files.length>0){
    const file = e.target.files[0];
    sendPhoto(file);
    // reset input aby moÅ¼na byÅ‚o wybraÄ‡ ten sam plik ponownie
    e.target.value = '';
  }
});

function sendPhoto(file){
  if(!chatRunning) { alert('Najpierw uruchom czat (Start).'); return; }
  // prosty upload: przesyÅ‚amy wszystko co jest obrazkiem (akceptujemy image/*)
  const formData = new FormData();
  formData.append('photo', file);

  fetch('/upload', { method: 'POST', body: formData })
    .then(res => {
      if(!res.ok) throw new Error('BÅ‚Ä…d serwera');
      return res.json();
    })
    .then(data => {
      if(data && data.url){
        addPhotoMsg('self', data.url, avatarPreview.src);
        socket.emit('sendPhoto', data.url);
        playSound(soundSend);
      } else {
        console.error('NieprawidÅ‚owa odpowiedÅº serwera przy uploadzie:', data);
      }
    })
    .catch(err => {
      console.error('BÅ‚Ä…d wysyÅ‚ania zdjÄ™cia:', err);
      alert('BÅ‚Ä…d wysyÅ‚ania zdjÄ™cia. SprÃ³buj ponownie.');
    });
}

msgInput.addEventListener('drop', e=>{
  e.preventDefault();
  if(e.dataTransfer.files.length>0) sendPhoto(e.dataTransfer.files[0]);
});
msgInput.addEventListener('dragover', e=>{ e.preventDefault(); });

socket.on('receiveMessage', msg=>{
  if(msg.type==='text') addMsg('partner', msg.content, 'https://i.pravatar.cc/90');
  else if(msg.type==='photo') addPhotoMsg('partner', msg.content, 'https://i.pravatar.cc/90');
  playSound(soundReceive);
});
socket.on('partnerFound', ()=>{ addSystemMsg("Partner poÅ‚Ä…czony. MoÅ¼esz pisaÄ‡!"); });
socket.on('partnerStopped', ()=>{ 
  chatRunning=false; msgInput.disabled=true; sendBtn.disabled=true; stopBtn.disabled=true; 
  addSystemMsg("Partner zakoÅ„czyÅ‚ rozmowÄ™."); 
});

function addMsg(cls,text,avatar){
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  const img = document.createElement('img');
  img.className = 'avatar';
  img.src = avatar;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  div.appendChild(img);
  div.appendChild(bubble);
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function addPhotoMsg(cls,url,avatar){
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  const imgAvatar = document.createElement('img');
  imgAvatar.className = 'avatar';
  imgAvatar.src = avatar;
  const photo = document.createElement('img');
  photo.className = 'chat-img';
  photo.src = url;
  photo.style.maxWidth='120px';
  photo.style.maxHeight='120px';
  div.appendChild(imgAvatar);
  div.appendChild(photo);
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function addSystemMsg(text){
  const div = document.createElement('div');
  div.className = 'msg system';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  div.appendChild(bubble);
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}
</script>

</body>
</html>
